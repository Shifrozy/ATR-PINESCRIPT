//@version=6
strategy("ATR Trailing Stop (3 ATR from High/Low)", 
     overlay=true, 
     margin_long=100, margin_short=100, 
     process_orders_on_close=true)

// === Inputs ===
atrLength    = input.int(14, "ATR Length")
atrMult      = input.float(3.0, "ATR Multiple")
enableLong   = input.bool(true, "Enable Longs")
enableShort  = input.bool(true, "Enable Shorts")

// === ATR calculation ===
atrValue = ta.atr(atrLength)

// === Example Entry Conditions (can replace with your own rules) ===
longCond  = ta.crossover(ta.sma(close,10), ta.sma(close,30))
shortCond = ta.crossunder(ta.sma(close,10), ta.sma(close,30))

if (enableLong and longCond)
    strategy.entry("MyLong", strategy.long)

if (enableShort and shortCond)
    strategy.entry("MyShort", strategy.short)

// === Track Highest Close Since Long Entry and Lowest Close Since Short Entry ===
var float highestClose = na
var float lowestClose  = na

if strategy.position_size > 0
    // Long position → track max closing price
    highestClose := na(highestClose) ? close : math.max(highestClose, close)
    lowestClose := na
else if strategy.position_size < 0
    // Short position → track min closing price
    lowestClose := na(lowestClose) ? close : math.min(lowestClose, close)
    highestClose := na
else
    // Flat → reset
    highestClose := na
    lowestClose  := na

// === Dynamic Trailing Levels ===
longTrigger  = highestClose - (atrMult * atrValue)
shortTrigger = lowestClose  + (atrMult * atrValue)

// === Exit Conditions ===
exitLongCond  = (strategy.position_size > 0) and (close <= longTrigger)
exitShortCond = (strategy.position_size < 0) and (close >= shortTrigger)

if exitLongCond
    strategy.close("MyLong")

if exitShortCond
    strategy.close("MyShort")

// === Alerts ===
// These show up in the TradingView alert dialog so user can pick them directly
alertcondition(exitLongCond, title="Exit Long (ATR Trail)", 
     message="⚠️ Long exited: price dropped 3 ATRs from highest close.")
alertcondition(exitShortCond, title="Exit Short (ATR Trail)", 
     message="⚠️ Short exited: price rose 3 ATRs from lowest close.")

// Optional inline alerts if you also want "Any alert() function call"
if exitLongCond
    alert("⚠️ Long exited: price dropped 3 ATRs from highest close.", alert.freq_once_per_bar)

if exitShortCond
    alert("⚠️ Short exited: price rose 3 ATRs from lowest close.", alert.freq_once_per_bar)

// === Plotting for visualization ===
plot(highestClose, "Highest Close (Long Tracking)", color=color.new(color.green, 0))
plot(lowestClose,  "Lowest Close (Short Tracking)", color=color.new(color.purple, 0))
plot(longTrigger,  "ATR Stop for Long", color=color.red)
plot(shortTrigger, "ATR Stop for Short", color=color.blue)